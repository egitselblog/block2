<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2 Kişilik Blok Oyunu (Supabase)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Supabase JS SDK -->
    <script type="module">
        // Supabase kütüphanesini import et
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // --- GLOBAL DEĞİŞKENLER VE AYARLAR ---

        // Supabase yapılandırmasını al
        // Canvas ortamında bu değişkenler otomatik olarak sağlanır
        // Kendi projeniz için YOUR_SUPABASE_URL ve YOUR_SUPABASE_ANON_KEY kısımlarını doldurun
        const supabaseUrl = typeof __supabase_url !== 'undefined' 
            ? __supabase_url 
            : 'https://aqbkbzbovllhbiwnvgtt.supabase.co'; 
        const supabaseKey = typeof __supabase_key !== 'undefined' 
            ? __supabase_key 
            : 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxYmtiemJvdmxsaGJpd252Z3R0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODUyMjcsImV4cCI6MjA3Njc2MTIyN30._pLayMH4lIEj9rns7b-t_-PzKTEHOx6rABZ3k53bwFE';

        // Supabase istemcisini başlat
        const supabase = createClient(supabaseUrl, supabaseKey);

        let currentUserId = null;
        let currentUsername = "";
        let currentGameId = null;
        let playerNumber = null; // 1 veya 2
        
        // Supabase Realtime aboneliklerini tutmak için
        let gameSubscription = null; 
        let lobbySubscription = null;
        let inviteSubscription = null;
        let heartbeatInterval = null; // EKLENDİ: Yaşam sinyali için

        // Oyun tahtası ve parçalar için referanslar
        const gameBoardElement = document.getElementById('game-board');
        const piecesContainer = document.getElementById('pieces-container');
        
        let selectedPiece = null; // { index: 0, shape: [[1,1], [1,0]] }
        let currentBoardState = [];
        let currentPiecesState = [];

        // Supabase tablo adları (Firestore koleksiyon yolları yerine)
        const USERS_TABLE = 'users';
        const GAMES_TABLE = 'games';
        const INVITES_TABLE = 'invites';

        // --- BLOK PARÇA TANIMLARI ---
        // (Bu kısım Firebase versiyonuyla aynı)
        const PIECES = [
            // 1x1
            { shape: [[1]], color: 'bg-red-500' },
            // 1x2
            { shape: [[1, 1]], color: 'bg-blue-500' },
            // 2x1
            { shape: [[1], [1]], color: 'bg-blue-500' },
            // 1x3
            { shape: [[1, 1, 1]], color: 'bg-green-500' },
            // 3x1
            { shape: [[1], [1], [1]], color: 'bg-green-500' },
            // 2x2 Kare
            { shape: [[1, 1], [1, 1]], color: 'bg-yellow-500' },
            // L (3)
            { shape: [[1, 0], [1, 1]], color: 'bg-purple-500' },
            { shape: [[1, 1], [1, 0]], color: 'bg-purple-500' },
            { shape: [[1, 1], [0, 1]], color: 'bg-purple-500' },
            { shape: [[0, 1], [1, 1]], color: 'bg-purple-500' },
            // T (4)
            { shape: [[1, 1, 1], [0, 1, 0]], color: 'bg-indigo-500' },
            { shape: [[0, 1, 0], [1, 1, 1]], color: 'bg-indigo-500' },
            { shape: [[1, 0], [1, 1], [1, 0]], color: 'bg-indigo-500' },
            { shape: [[0, 1], [1, 1], [0, 1]], color: 'bg-indigo-500' },
            // 1x4
            { shape: [[1, 1, 1, 1]], color: 'bg-cyan-500' },
            // 4x1
            { shape: [[1], [1], [1], [1]], color: 'bg-cyan-500' },
            // 3x3 Kare
            { shape: [[1, 1, 1], [1, 1, 1], [1, 1, 1]], color: 'bg-orange-500' }
        ];

        // --- YARDIMCI FONKSİYONLAR ---
        // (Bu kısım Firebase versiyonuyla aynı)

        // Farklı ekranları göster/gizle
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        // Özel mesaj kutusu
        function showMessage(title, message) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-body').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
        }
        
        document.getElementById('message-close-btn').addEventListener('click', () => {
            document.getElementById('message-modal').classList.add('hidden');
        });

        // 3 rastgele yeni parça oluştur
        function generateNewPieces() {
            const newPieces = [];
            for (let i = 0; i < 3; i++) {
                const randomPiece = PIECES[Math.floor(Math.random() * PIECES.length)];
                newPieces.push(randomPiece);
            }
            return newPieces;
        }

        // 10x10 boş bir tahta oluşturur
        function createEmptyBoard() {
            return Array(10).fill(0).map(() => Array(10).fill(0));
        }

        // --- OYUN GİRİŞ VE LOBİ YÖNETİMİ (SUPABASE) ---

        // (EKLENDİ) Yaşam sinyali
        async function sendHeartbeat() {
            if (!currentUserId) return;
            try {
                // 'upsert' kullanarak kullanıcıyı ekle VEYA 'timestamp'i güncelle
                const { error } = await supabase
                    .from(USERS_TABLE)
                    .upsert({ 
                        id: currentUserId, // PK (auth.users.id ile aynı)
                        name: currentUsername, // İsim değişmiş olabilir
                        is_online: true, 
                        timestamp: new Date().toISOString()
                    });
                if (error) throw error;
            } catch (error) {
                console.warn("Heartbeat failed:", error.message);
                // Bu kritik bir hata değil, sadece bir sonraki sinyal başarısız olur
            }
        }


        // Kullanıcı girişi
        document.getElementById('login-btn').addEventListener('click', async () => {
            const usernameInput = document.getElementById('username-input');
            const username = usernameInput.value.trim();
            if (username.length < 3) {
                showMessage('Hata', 'Kullanıcı adı en az 3 karakter olmalıdır.');
                return;
            }
            if (!currentUserId) {
                showMessage('Hata', 'Kullanıcı kimliği alınamadı. Lütfen bekleyin.');
                return;
            }
            
            currentUsername = username;
            
            try {
                // (DEĞİŞTİ) Sinyali hemen gönder (girişte)
                await sendHeartbeat();
                
                // Lobiyi göster
                document.getElementById('user-id-display').textContent = `Kullanıcı ID: ${currentUserId}`;
                showView('lobby-screen');
                setupLobbyListeners();

            } catch (error) {
                console.error("Giriş hatası:", error);
                showMessage('Giriş Hatası', 'Sunucuya bağlanırken bir hata oluştu.');
            }
        });

        // Lobi dinleyicilerini (Supabase Realtime) ayarla
        async function setupLobbyListeners() {
            // Önce mevcut kullanıcıları bir kez çek
            await fetchLobbyUsers();
            
            // (EKLENDİ) Yaşam sinyalini başlat
            if (heartbeatInterval) clearInterval(heartbeatInterval); // Öncekini temizle
            heartbeatInterval = setInterval(sendHeartbeat, 15000); // Her 15 saniyede bir

            // Aktif kullanıcıları (users tablosu) dinle
            if (lobbySubscription) lobbySubscription.unsubscribe(); // Önceki aboneliği kaldır
            lobbySubscription = supabase
                .channel('public:users')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: USERS_TABLE }, 
                    (payload) => {
                        console.log('Users tablosunda değişiklik:', payload);
                        // Değişiklik olduğunda listeyi yeniden çek
                        fetchLobbyUsers();
                    }
                )
                .subscribe();

            // Gelen davetleri dinle (sadece bana gelen davetler)
            if (inviteSubscription) inviteSubscription.unsubscribe();
            inviteSubscription = supabase
                .channel(`public:invites:to_id=eq.${currentUserId}`)
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: INVITES_TABLE, filter: `to_id=eq.${currentUserId}` },
                    (payload) => {
                        console.log('Davet değişikliği:', payload);
                        if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                            const invite = payload.new;
                            document.getElementById('invite-sender-name').textContent = invite.from_name;
                            document.getElementById('invite-data').dataset.inviterId = invite.from_id;
                            document.getElementById('invite-data').dataset.inviterName = invite.from_name;
                            document.getElementById('invite-modal').classList.remove('hidden');
                        } else if (payload.eventType === 'DELETE') {
                            document.getElementById('invite-modal').classList.add('hidden');
                        }
                    }
                )
                .subscribe();
            
            // Başlangıçta bekleyen davet var mı diye kontrol et
            checkPendingInvite();
        }

        // Lobi kullanıcılarını çeken yardımcı fonksiyon
        async function fetchLobbyUsers() {
            // (DEĞİŞTİ) Sadece son 30 saniye içinde sinyal göndermiş olanları çek
            const thirtySecondsAgo = new Date(Date.now() - 30000);
            
            const { data: users, error } = await supabase
                .from(USERS_TABLE)
                .select('id, name')
                // .eq('is_online', true) // (KALDIRILDI) - timestamp kontrolü daha güvenilir
                .gt('timestamp', thirtySecondsAgo.toISOString()) // (EKLENDİ)
                .neq('id', currentUserId); // Kendim hariç

            if (error) {
                console.error('Kullanıcıları çekerken hata:', error);
                return;
            }
            
            const userList = document.getElementById('user-list');
            userList.innerHTML = ''; // Listeyi temizle
            if (users && users.length > 0) {
                users.forEach(user => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-3 bg-gray-700 rounded-lg';
                    li.innerHTML = `
                        <span class="font-medium">${user.name}</span>
                        <button data-id="${user.id}" data-name="${user.name}" class="invite-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md transition-colors">
                            Davet Et
                        </button>
                    `;
                    userList.appendChild(li);
                });
                
                // Davet et butonlarına tıklama olayı ekle
                document.querySelectorAll('.invite-btn').forEach(button => {
                    button.addEventListener('click', handleSendInvite);
                });
            } else {
                 userList.innerHTML = '<li class="text-center text-gray-400">Aktif oyuncu bulunamadı.</li>';
            }
        }
        
        // Bekleyen daveti kontrol et
        async function checkPendingInvite() {
             const { data, error } = await supabase
                .from(INVITES_TABLE)
                .select('*')
                .eq('to_id', currentUserId) // PK (veya hedeflenen ID)
                .single();
                
            if (data) {
                document.getElementById('invite-sender-name').textContent = data.from_name;
                document.getElementById('invite-data').dataset.inviterId = data.from_id;
                document.getElementById('invite-data').dataset.inviterName = data.from_name;
                document.getElementById('invite-modal').classList.remove('hidden');
            }
        }

        // Davet gönderme
        async function handleSendInvite(e) {
            const targetId = e.target.dataset.id;
            const targetName = e.target.dataset.name;
            
            try {
                // Rakibin zaten bir daveti var mı? (PK 'to_id' varsayımıyla)
                const { data } = await supabase
                    .from(INVITES_TABLE)
                    .select('to_id')
                    .eq('to_id', targetId)
                    .single();

                if (data) {
                    showMessage('Bekle', `${targetName} kullanıcısının zaten bekleyen bir daveti var.`);
                    return;
                }

                // Kendi bekleyen davetimizi silelim (varsa)
                await supabase.from(INVITES_TABLE).delete().eq('to_id', currentUserId);

                // Davet gönder (PK 'to_id')
                const { error: insertError } = await supabase
                    .from(INVITES_TABLE)
                    .insert({
                        to_id: targetId, // Davet edilen (PK)
                        from_id: currentUserId,
                        from_name: currentUsername,
                        timestamp: new Date().toISOString()
                    });
                
                if (insertError) throw insertError;
                
                showMessage('Davet Gönderildi', `${targetName} kullanıcısına davet gönderildi. Cevap bekleniyor...`);
                
                // Oyunun kabul edilmesini dinle
                listenForGameAcceptance(targetId);

            } catch (error) {
                console.error("Davet gönderme hatası:", error);
                showMessage('Hata', 'Davet gönderilemedi.');
            }
        }

        // Daveti kabul etme
        document.getElementById('accept-invite-btn').addEventListener('click', async () => {
            const inviterId = document.getElementById('invite-data').dataset.inviterId;
            const inviterName = document.getElementById('invite-data').dataset.inviterName;
            
            const gameId = `${inviterId}_${currentUserId}`; // Sabit bir oyun ID'si
            
            try {
                // ---
                // HATA DÜZELTMESİ (AÇIKLAMA):
                // Eğer konsolda "Could not find the 'shared_pieces' column" hatası alıyorsanız,
                // bunun anlamı Supabase'teki 'games' tablonuzda 'shared_pieces' sütunu eksiktir.
                //
                // ÇÖZÜM: Supabase projenizdeki "SQL Editor" bölümüne gidin ve 
                // aşağıdaki komutu yapıştırıp çalıştırın:
                //
                // ALTER TABLE public.games ADD COLUMN shared_pieces JSONB;
                //
                // Bu komut, eksik olan 'shared_pieces' sütununu 'games' tablonuza ekleyecektir.
                // ---

                // (DEĞİŞTİ) Yeni oyun dökümanı oluştur VEYA mevcut oyunu sıfırla (UPSERT)
                const { error: gameError } = await supabase
                    .from(GAMES_TABLE)
                    .upsert({ // <-- DEĞİŞTİ: insert yerine upsert
                        id: gameId, // PK
                        player1_id: inviterId,
                        player1_name: inviterName,
                        player1_score: 0,
                        
                        player2_id: currentUserId,
                        player2_name: currentUsername,
                        player2_score: 0,
                        
                        shared_pieces: JSON.stringify(generateNewPieces()), // DEĞİŞTİ: Ortak parçalar
                        
                        board: JSON.stringify(createEmptyBoard()), // JSONB olarak sakla
                        turn: inviterId, // İlk sıra davet edende
                        status: 'active', // 'active', 'finished'
                        winner: null,
                        last_move_by: null
                    });
                
                if (gameError) throw gameError; // Hata varsa catch bloğuna atla

                // Daveti sil (PK 'to_id' idi)
                const { error: deleteError } = await supabase
                    .from(INVITES_TABLE)
                    .delete()
                    .eq('to_id', currentUserId);
                
                if (deleteError) throw deleteError;

                // (EKLENDİ) Davet ekranını kapat
                document.getElementById('invite-modal').classList.add('hidden');
                
                // Oyunu başlat (Oyuncu 2 olarak)
                startGame(gameId, 2);
                
            } catch (error) {
                // (DEĞİŞTİ) Hatayı konsola daha detaylı yazdır
                console.error("Davet kabul etme hatası (Supabase):", error.message);
                showMessage('Hata', 'Oyuna katılırken bir sorun oluştu.');
            }
        });

        // Daveti reddetme
        document.getElementById('decline-invite-btn').addEventListener('click', async () => {
            try {
                await supabase.from(INVITES_TABLE).delete().eq('to_id', currentUserId);
            } catch (error) {
                console.error("Davet reddetme hatası:", error);
            }
            document.getElementById('invite-modal').classList.add('hidden');
        });

        // Davet edenin, oyunun kabul edilmesini beklemesi
        function listenForGameAcceptance(targetId) {
            const gameId = `${currentUserId}_${targetId}`;
            
            const acceptanceSubscription = supabase
                .channel(`public:games:id=eq.${gameId}`)
                .on('postgres_changes', 
                    // Sadece bu ID'li oyun EKLENDİĞİNDE tetiklen
                    // { event: 'INSERT', schema: 'public', table: GAMES_TABLE, filter: `id=eq.${gameId}` }, // <-- ESKİ HATALI KOD
                    
                    // --- DÜZELTME ---
                    // 'upsert' komutu 'INSERT' veya 'UPDATE' yapabilir.
                    // Her iki durumu da yakalamak için 'event: *' kullanıyoruz.
                    { event: '*', schema: 'public', table: GAMES_TABLE, filter: `id=eq.${gameId}` },
                    (payload) => {
                        // payload.new, hem INSERT hem de UPDATE olaylarında güncel veriyi içerir
                        if (payload.new && payload.new.status === 'active') {
                            acceptanceSubscription.unsubscribe(); // Dinleyiciyi kaldır
                            
                            // (EKLENDİ) Davet edenin "Davet Gönderildi" modalını kapat
                            document.getElementById('message-modal').classList.add('hidden');
                            
                            startGame(gameId, 1); // Oyunu başlat (Oyuncu 1 olarak)
                        }
                    }
                )
                .subscribe();
            
            // Belli bir süre sonra zaman aşımına uğrat
            setTimeout(() => acceptanceSubscription.unsubscribe(), 60000); // 1 dakika bekle
        }

        // --- OYUN MANTIĞI (SUPABASE) ---
        
        // Oyunu başlat
        async function startGame(gameId, pNum) {
            currentGameId = gameId;
            playerNumber = pNum;
            
            // Lobi dinleyicilerini durdur
            if (lobbySubscription) lobbySubscription.unsubscribe();
            if (inviteSubscription) inviteSubscription.unsubscribe();
            if (heartbeatInterval) clearInterval(heartbeatInterval); // (EKLENDİ) Yaşam sinyalini durdur
            lobbySubscription = null;
            inviteSubscription = null;
            heartbeatInterval = null;
            
            // Oyun ekranını göster
            showView('game-screen');
            
            // Oyunu dinlemeye başla (UPDATE ve DELETE olayları)
            if (gameSubscription) gameSubscription.unsubscribe();
            gameSubscription = supabase
                .channel(`public:games:id=eq.${gameId}`)
                .on('postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: GAMES_TABLE, filter: `id=eq.${gameId}` },
                    (payload) => {
                        const game = payload.new;
                        updateGameUI(game); // UI'ı güncelle
                        
                        if (game.status === 'finished') {
                            handleGameOver(game);
                        }
                    }
                )
                .on('postgres_changes',
                    { event: 'DELETE', schema: 'public', table: GAMES_TABLE, filter: `id=eq.${gameId}` },
                    (payload) => {
                        stopGame('Rakip oyundan ayrıldı (oyun silindi).');
                    }
                )
                .subscribe();
            
            // İlk oyun durumunu manuel olarak çek (sayfa yenilenmesi veya ilk katılım için)
            await fetchInitialGameState(gameId);
        }
        
        // İlk oyun durumunu çek
        async function fetchInitialGameState(gameId) {
             const { data: game, error } = await supabase
                .from(GAMES_TABLE)
                .select('*')
                .eq('id', gameId)
                .single();
            
            if (error) {
                console.error('Oyun durumu alınamadı:', error);
                stopGame('Oyun durumu alınamadı.');
            } else if (game) {
                updateGameUI(game);
            }
        }

        // Oyunu durdur
        function stopGame(message) {
            if (gameSubscription) gameSubscription.unsubscribe();
            gameSubscription = null;
            currentGameId = null;
            playerNumber = null;
            selectedPiece = null;
            
            showMessage('Oyun Bitti', message);
            showView('lobby-screen'); // Lobiye dön
            setupLobbyListeners(); // Lobi dinleyicilerini tekrar başlat
        }

        // Oyun Arayüzünü Güncelle (Firebase ile aynı)
        function updateGameUI(game) {
            // Skoları ve isimleri güncelle
            const p1ScoreEl = document.getElementById('player1-score');
            const p2ScoreEl = document.getElementById('player2-score');
            
            p1ScoreEl.textContent = `${game.player1_name} (P1): ${game.player1_score}`;
            p2ScoreEl.textContent = `${game.player2_name} (P2): ${game.player2_score}`;
            
            // Sıra kimde?
            const turnInfo = document.getElementById('turn-info');
            if (game.turn === currentUserId) {
                turnInfo.textContent = "Sıra Sende!";
                turnInfo.className = "text-center text-2xl font-bold text-green-400 mb-4";
            } else {
                const opponentName = (playerNumber === 1) ? game.player2_name : game.player1_name;
                turnInfo.textContent = `Sıra ${opponentName}'da...`;
                turnInfo.className = "text-center text-2xl font-bold text-yellow-400 mb-4";
            }
            
            // Tahtayı çiz (JSONB'den gelen JSON string'i parse et)
            currentBoardState = JSON.parse(game.board);
            renderBoard(currentBoardState);
            
            // Parçaları çiz (JSONB'den gelen JSON string'i parse et)
            // const myPiecesKey = `player${playerNumber}_pieces`; // ESKİ KOD
            // currentPiecesState = JSON.parse(game[myPiecesKey]); // ESKİ KOD
            currentPiecesState = JSON.parse(game.shared_pieces); // DEĞİŞTİ: Ortak parçaları oku
            renderPieces(currentPiecesState, game.turn === currentUserId);
        }

        // Oyun tahtasını HTML'e dök (Firebase ile aynı)
        function renderBoard(board) {
            gameBoardElement.innerHTML = '';
            board.forEach((row, y) => {
                row.forEach((cell, x) => {
                    const cellEl = document.createElement('div');
                    cellEl.className = 'w-8 h-8 md:w-10 md:h-10 border border-gray-600 flex items-center justify-center';
                    cellEl.dataset.x = x;
                    cellEl.dataset.y = y;
                    
                    if (cell === 1) { // Dolu hücre
                        cellEl.classList.add('bg-gray-400');
                    } else { // Boş hücre
                        cellEl.classList.add('bg-gray-800', 'hover:bg-gray-700');
                    }
                    
                    // Hücreye tıklama olayı
                    cellEl.addEventListener('click', () => handleCellClick(x, y));
                    
                    // Parçayı yerleştirmeden önce önizleme (hover)
                    cellEl.addEventListener('mouseenter', () => showPlacementPreview(x, y, true));
                    cellEl.addEventListener('mouseleave', () => showPlacementPreview(x, y, false));
                    
                    gameBoardElement.appendChild(cellEl);
                });
            });
        }
        
        // Kullanıcının parçalarını HTML'e dök (Firebase ile aynı)
        function renderPieces(pieces, isMyTurn) {
            piecesContainer.innerHTML = '';
            pieces.forEach((piece, index) => {
                if (piece === null) { // Kullanılmış parça
                    const pieceEl = document.createElement('div');
                    pieceEl.className = 'w-24 h-24 m-2 bg-gray-900 rounded-lg opacity-50';
                    piecesContainer.appendChild(pieceEl);
                    return;
                }
                
                const pieceEl = document.createElement('div');
                pieceEl.className = 'w-24 h-24 m-2 p-2 flex flex-col items-center justify-center bg-gray-700 rounded-lg cursor-pointer transition-all';
                pieceEl.dataset.index = index;
                
                if (selectedPiece && selectedPiece.index === index) {
                    pieceEl.classList.add('ring-4', 'ring-blue-500', 'scale-105');
                }
                
                if (!isMyTurn) {
                    pieceEl.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    pieceEl.addEventListener('click', () => {
                        selectedPiece = { index: index, shape: piece.shape, color: piece.color };
                        // Arayüzü anında güncelle (renderPieces tekrar çağrılacak)
                        renderPieces(pieces, isMyTurn); 
                    });
                }
                
                // Parçanın küçük bir görselini oluştur
                piece.shape.forEach(row => {
                    const rowEl = document.createElement('div');
                    rowEl.className = 'flex';
                    row.forEach(cell => {
                        const cellEl = document.createElement('div');
                        cellEl.className = 'w-4 h-4';
                        if (cell === 1) {
                            cellEl.classList.add(piece.color);
                        }
                        rowEl.appendChild(cellEl);
                    });
                    pieceEl.appendChild(rowEl);
                });
                
                piecesContainer.appendChild(pieceEl);
            });
        }
        
        // Parça yerleştirme önizlemesi (Firebase ile aynı)
        function showPlacementPreview(startX, startY, show) {
            if (!selectedPiece || !gameBoardElement) return;

            const { shape } = selectedPiece;
            const isValid = checkValidPlacement(shape, startX, startY, currentBoardState);
            
            for (let y = 0; y < shape.length; y++) {
                for (let x = 0; x < shape[y].length; x++) {
                    if (shape[y][x] === 1) {
                        const boardX = startX + x;
                        const boardY = startY + y;
                        const cell = gameBoardElement.querySelector(`[data-x="${boardX}"][data-y="${boardY}"]`);
                        if (cell) {
                            if (show) {
                                cell.classList.add(isValid ? 'bg-green-300' : 'bg-red-300', 'opacity-50');
                            } else {
                                // Sadece hover sınıflarını kaldır, doluysa kendi rengini koru
                                cell.classList.remove('bg-green-300', 'bg-red-300', 'opacity-50');
                            }
                        }
                    }
                }
            }
        }

        // Tahtaya tıklamayı yönet (Supabase update)
        async function handleCellClick(x, y) {
            // Yarış koşullarını (race conditions) önlemek için önce mevcut durumu al
            const { data: game, error: fetchError } = await supabase
                .from(GAMES_TABLE)
                .select('*')
                .eq('id', currentGameId)
                .single();

            if (fetchError || !game) {
                console.error("Oyun durumu alınamadı:", fetchError);
                return;
            }

            // Sıra bende mi ve parça seçili mi?
            if (game.turn !== currentUserId || !selectedPiece) {
                return;
            }
            
            const board = JSON.parse(game.board);
            
            // Yerleştirme geçerli mi?
            if (checkValidPlacement(selectedPiece.shape, x, y, board)) {
                // 1. Parçayı tahtaya yerleştir
                const { newBoard, cellsPlaced } = placePiece(selectedPiece.shape, x, y, board);
                
                // 2. Çizgileri kontrol et ve temizle
                const { clearedBoard, clearedLinesCount } = clearLines(newBoard);
                
                // 3. Puanı hesapla (Firebase ile aynı mantık)
                let scoreGained = cellsPlaced + (clearedLinesCount * 10);
                if (clearedLinesCount > 1) scoreGained += clearedLinesCount * 5; // Bonus
                
                const myScoreKey = `player${playerNumber}_score`;
                // const myPiecesKey = `player${playerNumber}_pieces`; // ESKİ KOD
                // const opponentPiecesKey = `player${playerNumber === 1 ? 2 : 1}_pieces`; // ESKİ KOD
                const opponentId = (playerNumber === 1) ? game.player2_id : game.player1_id;

                let myNewScore = game[myScoreKey] + scoreGained;
                
                // 4. Kullandığım parçayı güncelle (DEĞİŞTİ: Ortak parçaları güncelle)
                let newSharedPieces = JSON.parse(game.shared_pieces); // DEĞİŞTİ: Ortak parçaları al
                newSharedPieces[selectedPiece.index] = null; // Parçayı kullanıldı olarak işaretle
                
                // 6. Oyun bitti mi kontrol et (parçalar yenilenmeden ÖNCE)
                const isGameOver = checkGameOver(newSharedPieces, clearedBoard);
                
                // 7. Tüm parçalar kullanıldıysa yenilerini ver
                let piecesToSave = newSharedPieces;
                if (newSharedPieces.every(p => p === null)) {
                    piecesToSave = generateNewPieces();
                }
                
                let newStatus = 'active';
                let winnerId = null;
                
                if (isGameOver) {
                    newStatus = 'finished';
                    const opponentScoreKey = `player${playerNumber === 1 ? 2 : 1}_score`;
                    const opponentScore = game[opponentScoreKey];
                    
                    if (myNewScore > opponentScore) {
                        winnerId = currentUserId;
                    } else if (opponentScore > myNewScore) {
                        winnerId = opponentId;
                    } else {
                        winnerId = 'draw'; // Berabere
                    }
                }

                // 8. Supabase'i güncelle
                try {
                    const { error: updateError } = await supabase
                        .from(GAMES_TABLE)
                        .update({
                            board: JSON.stringify(clearedBoard),
                            [myScoreKey]: myNewScore,
                            // [myPiecesKey]: JSON.stringify(myNewPieces), // ESKİ KOD
                            shared_pieces: JSON.stringify(piecesToSave), // DEĞİŞTİ: Ortak parçaları güncelle
                            turn: opponentId, // Sırayı rakibe ver
                            status: newStatus,
                            winner: winnerId,
                            last_move_by: currentUserId
                        })
                        .eq('id', currentGameId); // Sadece bu oyunu güncelle

                    if (updateError) throw updateError;
                    
                    selectedPiece = null; // Seçimi temizle
                    
                } catch (error) {
                    console.error("Hamle güncelleme hatası:", error);
                    showMessage('Hata', 'Hamleniz sunucuya iletilemedi.');
                }
                
            } else {
                showMessage('Geçersiz Hamle', 'Parçayı buraya yerleştiremezsiniz.');
            }
        }
        
        // --- GERİ KALAN OYUN MANTIĞI FONKSİYONLARI (Firebase ile %100 aynı) ---
        
        // Parçanın (x, y) konumuna yerleştirilip yerleştirilemeyeceğini kontrol et
        function checkValidPlacement(shape, startX, startY, board) {
            for (let y = 0; y < shape.length; y++) {
                for (let x = 0; x < shape[y].length; x++) {
                    if (shape[y][x] === 1) { // Parçanın bir hücresi
                        const boardX = startX + x;
                        const boardY = startY + y;
                        
                        // Tahta sınırları dışı
                        if (boardY >= board.length || boardX >= board[0].length) {
                            return false;
                        }
                        
                        // Başka bir parçanın üzeri
                        if (board[boardY][boardX] === 1) {
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        // Parçayı tahtaya yerleştir (kopyasını döndür)
        function placePiece(shape, startX, startY, board) {
            let cellsPlaced = 0;
            const newBoard = board.map(row => [...row]); // Deep copy
            
            for (let y = 0; y < shape.length; y++) {
                for (let x = 0; x < shape[y].length; x++) {
                    if (shape[y][x] === 1) {
                        newBoard[startY + y][startX + x] = 1;
                        cellsPlaced++;
                    }
                }
            }
            return { newBoard, cellsPlaced };
        }

        // Dolu satırları ve sütunları temizle
        function clearLines(board) {
            let newBoard = board.map(row => [...row]);
            let clearedLinesCount = 0;
            
            const rowsToClear = [];
            const colsToClear = [];
            
            // Satırları kontrol et
            for (let y = 0; y < 10; y++) {
                if (newBoard[y].every(cell => cell === 1)) {
                    rowsToClear.push(y);
                    clearedLinesCount++;
                }
            }
            
            // Sütunları kontrol et
            for (let x = 0; x < 10; x++) {
                let colFull = true;
                for (let y = 0; y < 10; y++) {
                    if (newBoard[y][x] === 0) {
                        colFull = false;
                        break;
                    }
                }
                if (colFull) {
                    colsToClear.push(x);
                    clearedLinesCount++;
                }
            }
            
            // Temizle
            rowsToClear.forEach(y => {
                for (let x = 0; x < 10; x++) newBoard[y][x] = 0;
            });
            colsToClear.forEach(x => {
                for (let y = 0; y < 10; y++) newBoard[y][x] = 0;
            });
            
            return { clearedBoard: newBoard, clearedLinesCount };
        }
        
        // Oyuncunun elindeki parçalarla hamle yapıp yapamayacağını kontrol et
        function checkGameOver(pieces, board) {
            // Eğer tüm parçalar null ise (yeni dağıtılacaksa) oyun bitmez
            if (pieces.every(p => p === null)) return false;
            
            for (const piece of pieces) {
                if (piece === null) continue; // Kullanılmış parçayı atla
                
                // Tahtadaki her olası konumu dene
                for (let y = 0; y < 10; y++) {
                    for (let x = 0; x < 10; x++) {
                        if (checkValidPlacement(piece.shape, x, y, board)) {
                            return false; // En az 1 geçerli hamle bulundu!
                        }
                    }
                }
            }
            
            return true; // Hiç geçerli hamle bulunamadı
        }
        
        // Oyun bitişini yönet
        function handleGameOver(game) {
            if (gameSubscription) gameSubscription.unsubscribe(); // Dinlemeyi durdur
            gameSubscription = null;
            
            let title = "Oyun Bitti!";
            let message = "";
            
            if (game.winner === 'draw') {
                title = "Berabere!";
                message = `Oyun berabere bitti. Skorlar eşit: ${game.player1_score}`;
            } else {
                const winnerName = (game.winner === game.player1_id) ? game.player1_name : game.player2_name;
                message = `Kazanan: ${winnerName}! \n\nSkor: ${game.player1_score} - ${game.player2_score}`;
            }
            
            document.getElementById('game-over-title').textContent = title;
            document.getElementById('game-over-body').textContent = message;
            document.getElementById('game-over-modal').classList.remove('hidden');
        }

        // Lobiye dön
        document.getElementById('game-over-close-btn').addEventListener('click', () => {
            document.getElementById('game-over-modal').classList.add('hidden');
            stopGame('Oyun sona erdi.');
        });
        
        // Pes et
        document.getElementById('forfeit-btn').addEventListener('click', async () => {
            if (!currentGameId || !playerNumber) return;
            
            // Rakip ID'sini almak için mevcut durumu çek
            const { data: game, error: fetchError } = await supabase
                .from(GAMES_TABLE)
                .select('player1_id, player2_id')
                .eq('id', currentGameId)
                .single();
            
            if (fetchError || !game) return;

            const opponentId = (playerNumber === 1) ? game.player2_id : game.player1_id;

            try {
                const { error: updateError } = await supabase
                    .from(GAMES_TABLE)
                    .update({
                        status: 'finished',
                        winner: opponentId, // Rakip kazanır
                        last_move_by: currentUserId
                    })
                    .eq('id', currentGameId);
                
                if (updateError) throw updateError;
                // Realtime dinleyicisi otomatik olarak handleGameOver'ı tetikleyecektir.
            } catch (error) {
                console.error("Pes etme hatası:", error);
                stopGame('Pes ederken bir hata oluştu.');
            }
        });


        // --- UYGULAMA BAŞLANGICI (SUPABASE AUTH) ---
        
        // Sayfa yüklendiğinde
        window.onload = async () => {
            // Supabase ile anonim olarak giriş yapmayı dene
            // (Supabase projenizde 'Enable Email Signup' kapalıyken
            // anonim girişler 'Enable Anonymous Sign-ins' ile açılmalıdır)
            const { data: { user }, error } = await supabase.auth.signInAnonymously();

            if (error) {
                console.error("Supabase kimlik doğrulama hatası:", error);
                showMessage('Bağlantı Hatası', 'Kimlik doğrulama sunucusuna bağlanılamadı. Lütfen Supabase ayarlarınızı kontrol edin.');
            } else if (user) {
                console.log("Giriş yapıldı, UID:", user.id);
                currentUserId = user.id;
                // Giriş ekranını göster
                showView('login-screen');
            }
            
            // (KALDIRILDI) 'beforeunload' olayı güvenilir değil, 'heartbeat' kullanılıyor
            // window.addEventListener('beforeunload', async () => { ... });
        };

    </script>
    
    <!-- STYLE (Firebase ile aynı) -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        /* Ekranların tam boyutta olmasını ve geçiş yapmasını sağlar */
        .view {
            min-height: 100vh;
            width: 100%;
        }
        /* Oyun tahtası grid'i */
        #game-board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            width: 320px; /* 10 * 32px */
            height: 320px; /* 10 * 32px */
            border: 2px solid #4a5568; /* gray-700 */
        }
        @media (min-width: 768px) {
            #game-board {
                width: 400px; /* 10 * 40px */
                height: 400px; /* 10 * 40px */
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden">

    <!-- HTML İÇERİĞİ (Firebase ile aynı) -->

    <!-- 1. Giriş Ekranı -->
    <div id="login-screen" class="view flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-sm bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h1 class="text-3xl font-bold text-center mb-6">Blok Savaşı</h1>
            <p class="text-center text-gray-400 mb-6">Oyuna girmek için bir kullanıcı adı belirleyin.</p>
            <input type="text" id="username-input" placeholder="Kullanıcı Adı" class="w-full px-4 py-3 bg-gray-700 text-white border border-gray-600 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" maxlength="15">
            <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-lg">
                Oyuna Gir
            </button>
        </div>
    </div>

    <!-- 2. Lobi Ekranı -->
    <div id="lobby-screen" class="view hidden flex-col items-center justify-start p-4 md:p-8">
        <h1 class="text-3xl font-bold text-center mb-6">Lobi</h1>
        <p id="user-id-display" class="text-sm text-gray-500 mb-4 bg-gray-800 px-3 py-1 rounded-full"></p>
        <div class="w-full max-w-md bg-gray-800 p-6 rounded-xl shadow-2xl">
            <h2 class="text-xl font-semibold mb-4">Aktif Oyuncular</h2>
            <ul id="user-list" class="space-y-3 h-64 overflow-y-auto">
                <!-- Kullanıcılar JS ile eklenecek -->
                <li class="text-center text-gray-400">Aktif oyuncu aranıyor...</li>
            </ul>
        </div>
    </div>

    <!-- 3. Oyun Ekranı -->
    <div id="game-screen" class="view hidden flex-col items-center justify-center p-2 md:p-4">
        <!-- Skor Tablosu -->
        <div class="w-full max-w-md mb-4 flex justify-between text-lg">
            <span id="player1-score" class="font-bold text-blue-300">Oyuncu 1: 0</span>
            <span id="player2-score" class="font-bold text-red-300">Oyuncu 2: 0</span>
        </div>
        
        <!-- Sıra Bilgisi -->
        <div id="turn-info" class="text-center text-2xl font-bold text-gray-300 mb-4">
            Oyun Yükleniyor...
        </div>

        <!-- Oyun Tahtası -->
        <div id="game-board" class="bg-gray-800 rounded-lg shadow-inner mb-4">
            <!-- Hücreler JS ile eklenecek -->
        </div>
        
        <!-- Parçalar -->
        <div id="pieces-container" class="flex justify-center items-center bg-gray-800 p-2 rounded-lg shadow-lg">
            <!-- Parçalar JS ile eklenecek -->
        </div>
        
        <!-- Pes Et Butonu -->
        <button id="forfeit-btn" class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">
            Pes Et
        </button>
    </div>

    <!-- Modallar (Firebase ile aynı) -->
    
    <!-- Gelen Davet Modalı -->
    <div id="invite-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full">
            <h2 class="text-2xl font-bold text-center mb-4">Oyun Daveti</h2>
            <p id="invite-data" class="text-center text-lg mb-6">
                <span id="invite-sender-name" class="font-bold text-yellow-400">...</span> kullanıcısı sizi oyuna davet ediyor!
            </p>
            <div class="flex justify-around">
                <button id="accept-invite-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    Kabul Et
                </button>
                <button id="decline-invite-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                    Reddet
                </button>
            </div>
        </div>
    </div>
    
    <!-- Genel Mesaj Modalı -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full">
            <h2 id="message-title" class="text-2xl font-bold text-center mb-4">Mesaj</h2>
            <p id="message-body" class="text-center text-lg mb-6">...</p>
            <div class="flex justify-center">
                <button id="message-close-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors">
                    Tamam
                </button>
            </div>
        </div>
    </div>
    
    <!-- Oyun Bitti Modalı -->
    <div id="game-over-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full">
            <h2 id="game-over-title" class="text-3xl font-bold text-center mb-4">Oyun Bitti!</h2>
            <p id="game-over-body" class="text-center text-lg whitespace-pre-line mb-8">...</p>
            <div class="flex justify-center">
                <button id="game-over-close-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors">
                    Lobiye Dön
                </button>
            </div>
        </div>
    </div>

</body>
</html>
